--- INACTIVE
select ods.mdm_party_id,idl.customer_id,idl.addr_status,idl.status_reason,idl.addr_type,idl.verification_status,upd.inactive,addr.isdeleted,concat('C',cast(upd.contacts_odw_id as STRING)) as addr_odw_id,concat('C',cast(ods.contacts_odw_id as STRING)) as ods_odw_id,concat('CA',cast(upd.contacts_addr_odw_id as string)) as hcp_addr_odw_id,mdm_Addr_id,upd.sf_id,addr.id,addr.address_odw__c,acct.account_odw__c,addr.address_mdm_id__c from all_all_b_usa_crmods.ods_contacts_addr upd left join ph_com_p_usa_veeva.address_vod__c addr on nvl(trim(concat('CA',cast(upd.contacts_addr_odw_id as string))),'@') = nvl(trim(addr.address_odw__c),'@') left join ph_com_p_usa_veeva.account acct on acct.id = addr.account_vod__c and acct.ispersonaccount = true and acct.isdeleted=false and acct.recordtypeid='0121O000001CG6UQAW' left join all_all_b_usa_crmods.ods_contacts ods on ods.contacts_odw_id=upd.contacts_odw_id left join all_all_e_gbl_customer.idl_mdm_address idl on idl.customer_id=ods.mdm_party_id  and idl.addr_id=upd.mdm_Addr_id where upper(upd.inactive)='TRUE' and upd.sf_id is  null and upd.mdm_Addr_id is not null

--- ACTIVE
select ods.mdm_party_id,idl.customer_id,idl.addr_status,idl.status_reason,idl.addr_type,idl.verification_status,upd.inactive,addr.isdeleted,concat('C',cast(upd.contacts_odw_id as STRING)) as addr_odw_id,concat('C',cast(ods.contacts_odw_id as STRING)) as ods_odw_id,concat('CA',cast(upd.contacts_addr_odw_id as string)) as hcp_addr_odw_id,mdm_Addr_id,upd.sf_id,addr.id,addr.address_odw__c,acct.account_odw__c,addr.address_mdm_id__c from all_all_b_usa_crmods.ods_contacts_addr upd left join ph_com_p_usa_veeva.address_vod__c addr on nvl(trim(concat('CA',cast(upd.contacts_addr_odw_id as string))),'@') = nvl(trim(addr.address_odw__c),'@') left join ph_com_p_usa_veeva.account acct on acct.id = addr.account_vod__c and acct.ispersonaccount = true and acct.isdeleted=false and acct.recordtypeid='0121O000001CG6UQAW' left join all_all_b_usa_crmods.ods_contacts ods on ods.contacts_odw_id=upd.contacts_odw_id left join (select customer_id,addr_id,status_reason,addr_status,addr_type,verification_status from all_all_e_gbl_customer.idl_mdm_address  where upper(addr_type) ='HCP') idl on idl.customer_id=ods.mdm_party_id  and idl.addr_id=upd.mdm_Addr_id where upper(upd.inactive)='FALSE' and upd.sf_id is  null and upd.mdm_Addr_id is not null


,addr1.id,addr1.address_odw__c,acct1.account_odw__c,addr1.address_mdm_id__c left join ph_com_p_usa_veeva.address_vod__c addr1 on nvl(trim(addr1.address_mdm_id__c),'@') = nvl(trim(upd.mdm_addr_id),'@') left join ph_com_p_usa_veeva.account acct1 on acct1.id = addr1.account_vod__c and acct1.ispersonaccount = true and acct1.isdeleted=false and acct1.recordtypeid='0121O000001CG6UQAW'



-------SOP ----


with upd_data as (select upd.inactive,concat('C',cast(contacts_odw_id as STRING)) as hcp_odw_id,concat('CA',cast(upd.contacts_addr_odw_id as string)) as hcp_addr_odw_id,mdm_Addr_id,sf_id,addr.id,addr.address_odw__c,acct.account_odw__c,addr.address_mdm_id__c from all_all_b_usa_crmods.ods_contacts_addr upd left join ph_com_p_usa_veeva.address_vod__c addr on nvl(trim(concat('CA',cast(upd.contacts_addr_odw_id as string))),'@') = nvl(trim(addr.address_odw__c),'@') left join ph_com_p_usa_veeva.account acct on acct.id = addr.account_vod__c and acct.ispersonaccount = true and acct.isdeleted=false and acct.recordtypeid='0121O000001CG6UQAW'  where upper(upd.inactive)='TRUE' and upd.sf_id is  null and upd.mdm_Addr_id is not null ), checked_data as 
(select *,case when trim(nvl(mdm_Addr_id,'@'))=trim(nvl(address_mdm_id__c,'@')) then true else false end as addr_mdm_id_check,case when trim(nvl(address_odw__c,'@'))=trim(nvl(hcp_addr_odw_id,'@')) then true else false end as addr_odw_id_check,case when trim(nvl(account_odw__c,'@'))=trim(nvl(hcp_odw_id,'@')) then true else false end as account_check,case when trim(nvl(sf_id,'@'))=trim(nvl(id,'@')) then true else false end as sf_id_check from upd_data), final_data as (
select id from checked_data where sf_id_check = false and addr_odw_id_check = true and account_check = true and addr_mdm_id_check = true)

select count(1) from final_data
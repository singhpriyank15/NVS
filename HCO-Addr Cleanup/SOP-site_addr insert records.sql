
spark.sql("""with union_data as (select * from all_all_r_all_bkp.hco_addr_base_query_case1 union select * from all_all_r_all_bkp.hco_addr_base_query_case2),case1a as (select id,address_mdm_id__c,address_odw__c,account_odw__c from all_all_r_all_bkp.hco_addr_base_query_case1 where sf_id is null and addr_o_addr_odw_id is null and addr_sf_sf_id is null), req_data as ( select u.* from union_data u left anti join case1a c on u.id=c.id and u.address_odw__c=c.address_odw__c  and u.account_odw__c=c.account_odw__c  and nvl(u.address_mdm_id__c, '@') = nvl(c.address_mdm_id__c, '@'))
select distinct id, address_odw__c, account_odw__c, address_mdm_id__c from req_data""").createOrReplaceTempView("req_data")
 
-- mdm_addr_id null records inserting from veeva
spark.sql("""insert into all_all_b_usa_crmods.ods_site_addr select null siebel_id, substring(addr.address_odw__c, 3, length(addr.address_odw__c)) site_addr_odw_id, addr.id sf_id, null sf_owner_id, null sf_is_deleted, null site_key, substring(rd.account_odw__c, 2) site_odw_id, addr.dea_vod__c dea, addr.dea_expiration_date_vod__c dea_expirn_date, addr.dea_license_address_vod__c dea_lic_addr, null site_name, addr.home_vod__c home, null mailing, addr.shipping_vod__c shipping, addr.mobile_id_vod__c mobile_id, addr.phone_vod__c phone, addr.phone_2_vod__c phone_2, fax_vod__c fax, fax_2_vod__c fax_2, addr.name site_phys_addr_line1, addr.address_line_2_vod__c site_phys_addr_line2, null site_phys_addr_line3, addr.city_vod__c site_phys_city, null site_phys_country, null site_phys_county, addr.state_vod__c site_phys_state, addr.zip_vod__c site_phys_zip, null site_post_addr_line1, null site_post_addr_line2, null site_post_addr_line3, null site_post_city, null site_post_country, null site_post_county, null site_post_state, null site_post_zip1, null site_post_zip2, null mdm_valid_addr_ind, addr.zip_4_vod__c zip_4, addr.license_expiration_date_vod__c lic_expirn_date, addr.license_status_vod__c lic_stat, addr.license_valid_to_sample_vod__c lic_valid_to_sample, addr.license_vod__c lic, addr.staff_notes_vod__c staff_notes, addr.source_vod__c src, addr.office_notes_vod__c office_notes, addr.include_in_territory_assignment_vod__c inc_in_terr_asgnmt, addr.appt_required_vod__c appt_reqd, addr.billing_vod__c billing, null business, addr.primary_vod__c primary, addr.sample_status_vod__c sample_stat, 'VOD' rec_insert_by, current_timestamp rec_insert_date, current_timestamp rec_modify_date, '2346' batch_id_insert, 'FALSE' inactive, 'FALSE' is_deleted, addr.address_mdm_id__c mdm_addr_id, null edge_id, null mdm_addr_src_sys, null mdm_cust_skey, null mdm_src_addr_type, null cust_addr_skey, addr.cass_certified__c cass_certified, addr.best_times_vod__c best_times, 'VOD' rec_modify_by, '1234' batch_id_update, addr.nvs_core_secondary_license__c nvs_core_secondary_license__c, addr.map_vod__c maps, sample_send_status_vod__c sample_send_status_vod__c, addr.nvs_core_novartis_unique_id__c nvs_core_novartis_unique_id__c from ph_com_p_usa_veeva.Address_vod__c addr join ( select * from req_data where address_mdm_id__c is null) rd on trim(addr.id)= trim(rd.id) join all_all_b_usa_crmods.ods_site site on concat('S', cast(site.site_odw_id as string)) = rd.account_odw__c""")



-- mdm_addr_id not null reocrds inserting from veeva as well as from idl which are active

spark.sql("""insert into all_all_b_usa_crmods.ods_site_addr select null siebel_id, substring(addr.address_odw__c, 3, length(addr.address_odw__c)) site_addr_odw_id, addr.id sf_id, null sf_owner_id, null sf_is_deleted, null site_key, substring(act.account_odw__c, 2) site_odw_id, addr.dea_vod__c dea, addr.dea_expiration_date_vod__c dea_expirn_date, addr.dea_license_address_vod__c dea_lic_addr, null site_name, addr.home_vod__c home, idl.mailing, addr.shipping_vod__c shipping, addr.mobile_id_vod__c mobile_id, addr.phone_vod__c phone, addr.phone_2_vod__c phone_2, addr.fax_vod__c fax, addr.fax_2_vod__c fax_2, idl.site_phys_addr_line1, idl.site_phys_addr_line2, idl.site_phys_addr_line3, idl.site_phys_city, idl.site_phys_country, idl.site_phys_county, idl.site_phys_state, idl.site_phys_zip, null site_post_addr_line1, null site_post_addr_line2, null site_post_addr_line3, null site_post_city, null site_post_country, null site_post_county, null site_post_state, null site_post_zip1, null site_post_zip2, idl.mdm_valid_addr_ind, idl.zip_4, addr.license_expiration_date_vod__c lic_expirn_date, addr.license_status_vod__c lic_stat, addr.license_valid_to_sample_vod__c lic_valid_to_sample, addr.license_vod__c lic, addr.staff_notes_vod__c staff_notes, addr.source_vod__c src, addr.office_notes_vod__c office_notes, addr.include_in_territory_assignment_vod__c inc_in_terr_asgnmt, addr.appt_required_vod__c appt_reqd, addr.billing_vod__c billing, idl.business, addr.primary_vod__c `primary`, addr.sample_status_vod__c sample_stat, 'VOD' rec_insert_by, current_timestamp() rec_insert_date, current_timestamp() rec_modify_date, idl.batch_id_insert, 'FALSE' inactive, 'FALSE' is_deleted, addr.address_mdm_id__c mdm_addr_id, null edge_id, null mdm_addr_src_sys, null mdm_cust_skey, null mdm_src_addr_type, null cust_addr_skey, addr.cass_certified__c cass_certified, addr.best_times_vod__c best_times, 'VOD' rec_modify_by, '1234' batch_id_update, addr.nvs_core_secondary_license__c nvs_core_secondary_license__c, addr.map_vod__c maps, addr.sample_send_status_vod__c sample_send_status_vod__c, act.nvs_core_novartis_unique_id__c from ph_com_p_usa_veeva.Address_vod__c addr join ( select * from req_data where address_mdm_id__c is not null ) rd on trim(addr.id) = trim(rd.id) join ( select account_odw__c, id, nvs_core_novartis_unique_id__c from ph_com_p_usa_veeva.account act where act.recordtypeid not in ('01270000000Mto8AAC', '0120S000000cbGUQAY') ) act on addr.account_vod__c = act.id  join ( select distinct trim(addr.addr_id) mdm_addr_id, addr_line_1 site_phys_addr_line1, addr_line_2 site_phys_addr_line2, addr_line_3 site_phys_addr_line3, city site_phys_city, state site_phys_state, zip site_phys_zip, site.site_odw_id site_odw_id, zip_ext zip_4, province site_phys_county, addr.country site_phys_country, verification_status mdm_valid_addr_ind, '234' batch_id_insert, addr.customer_id, a.business, a.mailing from ALL_ALL_E_GBL_CUSTOMER.idl_mdm_address addr join all_all_b_usa_crmods.ods_site site on trim(site.mdm_party_id)= trim(addr.customer_id) left outer join ( select addr_id, customer_id, max(case when trim(upper(addr_type)) = 'MAILING' then 'TRUE' else 'FALSE' end ) as mailing, max(case when trim(upper(addr_type)) = 'COMMERCIAL' then 'TRUE' else 'FALSE' end) as business from ALL_ALL_E_GBL_CUSTOMER.idl_mdm_address_type where trim(upper(status)) = 'A' group by addr_id, customer_id ) a on trim(a.addr_id)= trim(addr.addr_id) and trim(a.customer_id)= trim(addr.customer_id) where trim(addr.addr_status)= 'A' and trim(upper(addr.addr_type)) = 'HCO' and addr.status_reason is null) idl on trim(act.nvs_core_novartis_unique_id__c) = trim(idl.customer_id) and trim(addr.address_mdm_id__c) = trim(idl.mdm_addr_id) left anti join all_all_b_usa_crmods.ods_site_addr siteAddr on trim(idl.mdm_addr_id)= trim(siteAddr.mdm_addr_id) and idl.site_odw_id = siteAddr.site_odw_id and trim(addr.id)= trim(siteAddr.sf_id) and trim(addr.address_odw__c)= trim(concat('SA', cast(siteAddr.site_addr_odw_id as string))) and trim(addr.id)= trim(siteAddr.sf_id) where LastModifiedById not in('00570000001WPHhAAO') """)


